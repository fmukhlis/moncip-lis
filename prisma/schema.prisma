// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  laboratoryId  String?
  id            String          @id @default(cuid(2))
  name          String?
  email         String?          @unique
  username      String?          @unique
  emailVerified DateTime?
  image         String?
  role          Role            @default(admin)
  password      String?
  laboratory    Laboratory?     @relation(fields: [laboratoryId], references: [id])
  accounts      Account[]
  sessions      Session[]
  // Optional for WebAuthn support
  Authenticator Authenticator[]
 
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum Role {
  admin
  doctor
  lab_tech
}
 
model Account {
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
 
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
 
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
 
  @@id([provider, providerAccountId])
}
 
model Session {
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
 
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}
 
model VerificationToken {
  identifier String
  token      String
  expires    DateTime
 
  @@id([identifier, token])
}
 
// Optional for WebAuthn support
model Authenticator {
  credentialID         String  @unique
  userId               String
  providerAccountId    String
  credentialPublicKey  String
  counter              Int
  credentialDeviceType String
  credentialBackedUp   Boolean
  transports           String?
 
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
 
  @@id([userId, credentialID])
}

model Laboratory {
  id              String            @id @default(cuid(2))
  users           User[]
  labTests        LabTest[]
  labTestGroups   LabTestGroup[]    
}

model LabTest {
  categoryId        String
  methodId          String?
  defaultUnitId     String
  scaleId           String
  id                String              @id @default(cuid(2))
  code              String              @unique
  name              String
  possibleValues    String[]            @default([])
  isActive          Boolean             @default(true)
  
  scale             Scale               @relation(fields: [scaleId], references: [id])
  category          Category            @relation(fields: [categoryId], references: [id])
  method            Method?             @relation(fields: [methodId], references: [id])
  specimens         Specimen[]          
  defaultUnit       Unit                @relation("defaultUnit", fields: [defaultUnitId], references: [id])
  units             Unit[]              @relation("units")
  labTestGroups     LabTestGroup[]    
  referenceRanges   ReferenceRange[]    
  prices            Price[]
  laboratories      Laboratory[]
}

model LabTestGroup {
  categoryId      String
  id              String          @id @default(cuid(2))
  code            String          @unique
  name            String
  description     String?
  isActive        Boolean         @default(true)

  categories      Category[]    
  labTests        LabTest[]     
  laboratories    Laboratory[]    
}

model ReferenceRange {
  labTestId   String
  unitId      String
  id          String    @id @default(cuid(2))
  gender      Gender
  ageMin      Int
  ageMax      Int
  valueLow    Decimal
  valueHigh   Decimal

  labTest     LabTest   @relation(fields: [labTestId], references: [id])
  unit        Unit      @relation(fields: [unitId], references: [id])
}

enum Gender {
  M
  F
}

model Specimen {
  id              String      @id @default(cuid(2))
  code            String      @unique
  abbreviation    String
  name            String
  description     String?

  labTests        LabTest[]   
}

model Category {
  id              String            @id @default(cuid(2))
  code            String            @unique
  name            String
  description     String?

  labTestGroups   LabTestGroup[]    
  labTests        LabTest[]
}

model Method {
  id              String      @id @default(cuid(2))
  code            String      @unique
  abbreviation    String      
  name            String
  description     String?

  labTests        LabTest[]
}

model Unit {
  id                  String              @id @default(cuid(2))
  code                String              @unique
  displayCode         String
  name                String
  description         String?

  usedAsDefaultFor    LabTest[]           @relation("defaultUnit")
  labTests            LabTest[]           @relation("units")
  referenceRanges     ReferenceRange[]    
  conversionsFrom     UnitConversion[]    @relation("fromUnit")
  conversionTo        UnitConversion[]    @relation("toUnit")
}

model Scale {
  id              String      @id @default(cuid(2))
  code            String      @unique
  abbreviation    String
  name            String
  description     String?

  labTests        LabTest[]   
}

model UnitConversion {
  fromUnitId    String
  toUnitId      String
  id            String      @id @default(cuid(2))
  factor        Decimal
  offset        Decimal?    
  
  fromUnit      Unit        @relation("fromUnit", fields: [fromUnitId], references: [id])
  toUnit        Unit        @relation("toUnit", fields: [toUnitId], references: [id])

  @@unique([fromUnitId, toUnitId])
}

model TariffGroup {
  id            String    @id @default(cuid(2))
  code          String    @unique
  name          String
  description   String?

  prices        Price[]
}

model Price {
  labTestId       String
  tariffGroupId   String
  id              String        @id @default(cuid(2))
  price           Decimal   
  validFrom       DateTime      @default(now())
  validTo         DateTime?
  isActive        Boolean       @default(true)

  tariffGroup     TariffGroup   @relation(fields: [tariffGroupId], references: [id])
  labTest         LabTest       @relation(fields: [labTestId], references: [id])
}